<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</title>
  <link rel="stylesheet" href="static/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <h1>üìù –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</h1>
    <form id="profileForm">
      <input type="text" name="name" placeholder="–ò–º—è" required />
      <input type="text" name="surname" placeholder="–§–∞–º–∏–ª–∏—è" required />
      <input type="number" name="age" placeholder="–í–æ–∑—Ä–∞—Å—Ç" required min="18" />
      <select name="gender" required>
        <option value="">–ü–æ–ª</option>
        <option value="male">–ü–∞—Ä–µ–Ω—å</option>
        <option value="female">–î–µ–≤—É—à–∫–∞</option>
      </select>
      <input type="text" name="city" id="cityInput" placeholder="–ì–æ—Ä–æ–¥" required />
      <button type="button" id="detectLocationBtn">üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–æ—Ä–æ–¥</button>
      <input type="number" name="height" placeholder="–†–æ—Å—Ç (—Å–º)" required />
      <input type="number" name="weight" placeholder="–í–µ—Å (–∫–≥)" required />
      <select name="marital_status" required>
        <option value="">–°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ</option>
        <option value="single">–ù–µ –∂–µ–Ω–∞—Ç / –ù–µ –∑–∞–º—É–∂–µ–º</option>
        <option value="divorced">–í —Ä–∞–∑–≤–æ–¥–µ</option>
        <option value="widowed">–í–¥–æ–≤–µ—Ü / –í–¥–æ–≤–∞</option>
      </select>
      <select name="has_children" required>
        <option value="">–ï—Å—Ç—å –ª–∏ –¥–µ—Ç–∏?</option>
        <option value="true">–î–∞</option>
        <option value="false">–ù–µ—Ç</option>
      </select>
      <select name="education" required>
        <option value="">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
        <option value="primary">–ù–∞—á–∞–ª—å–Ω–æ–µ</option>
        <option value="secondary">–°—Ä–µ–¥–Ω–µ–µ</option>
        <option value="incomplete_higher">–ù–µ–æ–∫–æ–Ω—á–µ–Ω–Ω–æ–µ –≤—ã—Å—à–µ–µ</option>
        <option value="higher">–í—ã—Å—à–µ–µ</option>
      </select>
      <select name="goal" required>
        <option value="">–¶–µ–ª—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞</option>
        <option value="friendship">–î—Ä—É–∂–±–∞</option>
        <option value="communication">–û–±—â–µ–Ω–∏–µ</option>
        <option value="serious_relationship">–°–µ—Ä—å–µ–∑–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è</option>
        <option value="marriage">–ë—Ä–∞–∫</option>
      </select>
      <select name="polygamy">
        <option value="">–í—ã –ø—Ä–∏–µ–º–ª–µ—Ç–µ –ø–æ–ª–∏–≥–∞–º–∏—é?</option>
        <option value="true">–î–∞</option>
        <option value="false">–ù–µ—Ç</option>
        <option value="unsure">–ù–µ –∑–Ω–∞—é / –ù–µ —É–≤–µ—Ä–µ–Ω(–∞)</option>
      </select>
      <select name="religion" required>
        <option value="">–†–µ–ª–∏–≥–∏—è</option>
        <option value="islam">–ò—Å–ª–∞–º</option>
        <option value="christianity">–•—Ä–∏—Å—Ç–∏–∞–Ω—Å—Ç–≤–æ</option>
        <option value="judaism">–ò—É–¥–∞–∏–∑–º</option>
        <option value="buddhism">–ë—É–¥–¥–∏–∑–º</option>
        <option value="other">–î—Ä—É–≥–æ–µ</option>
      </select>
      <select name="religious_level">
        <option value="">–ù–∞—Å–∫–æ–ª—å–∫–æ –≤—ã —Ä–µ–ª–∏–≥–∏–æ–∑–Ω—ã?</option>
        <option value="none">–ù–µ —Ä–µ–ª–∏–≥–∏–æ–∑–µ–Ω(–∞)</option>
        <option value="low">–ù–µ–º–Ω–æ–≥–æ</option>
        <option value="medium">–°—Ä–µ–¥–Ω–µ</option>
        <option value="high">–û—á–µ–Ω—å</option>
        <option value="strict">–°–ª–µ–¥—É—é –≤—Å–µ–º –Ω–æ—Ä–º–∞–º</option>
      </select>
      <input type="text" name="ethnicity" placeholder="–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å" required />
      <input type="text" name="job" placeholder="–ü—Ä–æ—Ñ–µ—Å—Å–∏—è (–ø–æ –∂–µ–ª–∞–Ω–∏—é)" />
      <textarea name="about" placeholder="–û —Å–µ–±–µ (–¥–æ 300 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="300"></textarea>
      <textarea name="looking_for" placeholder="–ö–æ–≥–æ —Ç—ã –∏—â–µ—à—å? (–¥–æ 300 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="300"></textarea>

      <button type="submit">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>

  <!-- –í–°–¢–ê–í–õ–ï–ù–ù–´–ô –°–ö–†–ò–ü–¢ -->
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const cityInput = document.getElementById("cityInput");
    const detectLocationBtn = document.getElementById("detectLocationBtn");

    let userLatitude = null;
    let userLongitude = null;

    // üîπ –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ OpenStreetMap
    async function reverseGeocode(latitude, longitude) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10`);
        const data = await response.json();

        if (data.address) {
          const cityName = data.address.city || data.address.town || data.address.village || data.address.municipality || data.address.state;

          if (cityName) {
            cityInput.value = cityName;
            userLatitude = latitude;
            userLongitude = longitude;
          } else {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–æ—Ä–æ–¥");
          }
        }
      } catch (error) {
        console.error("Error reverse geocoding:", error);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –≥–æ—Ä–æ–¥–∞. –í–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.");
      }
    }

    // üîπ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏
    detectLocationBtn.addEventListener("click", () => {
      if (!navigator.geolocation) {
        alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ");
        return;
      }

      detectLocationBtn.disabled = true;
      detectLocationBtn.textContent = "‚è≥ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...";

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const { latitude, longitude } = position.coords;

          // üîÑ –í—ã–∑—ã–≤–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ nominatim –Ω–∞–ø—Ä—è–º—É—é
          await reverseGeocode(latitude, longitude);

          detectLocationBtn.disabled = false;
          detectLocationBtn.textContent = "üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–æ—Ä–æ–¥";
        },
        (error) => {
          alert("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: " + error.message);
          detectLocationBtn.disabled = false;
          detectLocationBtn.textContent = "üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–æ—Ä–æ–¥";
        }
      );
    });

    // üîπ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = Object.fromEntries(new FormData(e.target).entries());

      formData.has_children = formData.has_children === "true";
      if (formData.polygamy) {
        formData.polygamy = formData.polygamy === "true";
      }

      const payload = {
        action: 'profile_submit',
        ...formData,
        user_id: tg.initDataUnsafe?.user?.id,
        latitude: userLatitude,
        longitude: userLongitude
      };

      console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞:", payload);
      tg.sendData(JSON.stringify(payload));
      alert("–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!");
    });
  </script>
</body>
</html>
