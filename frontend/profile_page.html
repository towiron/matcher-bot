<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</title>
  <link rel="stylesheet" href="static/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <h1>üìù –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</h1>
    <form id="profileForm">
      <input type="text" name="name" placeholder="–ò–º—è" required />
      <input type="number" name="age" placeholder="–í–æ–∑—Ä–∞—Å—Ç" required min="18" />
      <select name="gender" required>
        <option value="">–ü–æ–ª</option>
        <option value="male">–ü–∞—Ä–µ–Ω—å</option>
        <option value="female">–î–µ–≤—É—à–∫–∞</option>
      </select>
      <select name="city" id="cityInput" required>
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
      </select>
       <input type="number" name="height" placeholder="–†–æ—Å—Ç (—Å–º)" required min="120" max="230" />
      <input type="number" name="weight" placeholder="–í–µ—Å (–∫–≥)" required min="30" max="250" />
      <select name="marital_status" id="maritalStatusInput" required>
        <option value="">–°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ</option>
      </select>
      <select name="has_children" required>
        <option value="">–ï—Å—Ç—å –ª–∏ –¥–µ—Ç–∏?</option>
        <option value="true">–î–∞</option>
        <option value="false">–ù–µ—Ç</option>
      </select>
      <select name="education" required>
        <option value="">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
        <option value="primary">–ù–∞—á–∞–ª—å–Ω–æ–µ</option>
        <option value="secondary">–°—Ä–µ–¥–Ω–µ–µ</option>
        <option value="incomplete_higher">–ù–µ–æ–∫–æ–Ω—á–µ–Ω–Ω–æ–µ –≤—ã—Å—à–µ–µ</option>
        <option value="higher">–í—ã—Å—à–µ–µ</option>
      </select>
      <select name="goal" required>
        <option value="">–¶–µ–ª—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞</option>
        <option value="friendship">–î—Ä—É–∂–±–∞</option>
        <option value="communication">–û–±—â–µ–Ω–∏–µ</option>
        <option value="serious_relationship">–°–µ—Ä—å–µ–∑–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è</option>
        <option value="marriage">–ë—Ä–∞–∫</option>
      </select>
      <select name="polygamy">
        <option value="">–ö–∞–∫–æ–π —Ç–∏–ø –æ—Ç–Ω–æ—à–µ–Ω–∏–π –≤—ã –ø—Ä–∏–µ–º–ª–µ—Ç–µ?</option>
        <option value="true">–ü–æ–ª–∏–≥–∞–º–∏—è</option>
        <option value="false">–ú–æ–Ω–æ–≥–∞–º–∏—è</option>
      </select>
      <select name="religion" id="religionInput" required>
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–ª–∏–≥–∏—é</option>
      </select>
      <select name="religious_level">
        <option value="">–ù–∞—Å–∫–æ–ª—å–∫–æ –≤—ã —Ä–µ–ª–∏–≥–∏–æ–∑–Ω—ã?</option>
        <option value="none">–ù–µ —Ä–µ–ª–∏–≥–∏–æ–∑–µ–Ω(–∞)</option>
        <option value="low">–ù–µ–º–Ω–æ–≥–æ</option>
        <option value="medium">–°—Ä–µ–¥–Ω–µ</option>
        <option value="high">–û—á–µ–Ω—å</option>
        <option value="strict">–°–ª–µ–¥—É—é –≤—Å–µ–º –Ω–æ—Ä–º–∞–º</option>
      </select>
      <select name="ethnicity" id="ethnicityInput" required>
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</option>
      </select>
      <input type="text" name="job" placeholder="–ü—Ä–æ—Ñ–µ—Å—Å–∏—è (–ø–æ –∂–µ–ª–∞–Ω–∏—é)" />
      <textarea name="about" placeholder="–û —Å–µ–±–µ (–ø—Ä–æ—Å–∏–º –≤–∞—Å –∑–∞–ø–æ–ª–Ω–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ —á—Ç–æ –±—ã –º—ã –º–æ–≥–ª–∏ –≤–∞–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ –ø–æ–¥–æ–±—Ä–∞—Ç—å —Å—á–∞—Å—Ç—å–µ ü´†)" maxlength="300"></textarea>
      <textarea name="looking_for" placeholder="–ö–æ–≥–æ –∏—â–∏—Ç–µ? (–ø—Ä–æ—Å–∏–º –æ–ø–∏—Å–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ —á—Ç–æ –±—ã –≤–∞—à–µ —Å—á–∞—Å—Ç—å–µ –º–æ–≥–ª–æ –≤–∞—Å –Ω–∞–π—Ç–∏)" maxlength="300"></textarea>

      <button type="submit">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>

  <!-- –°–ö–†–ò–ü–¢ -->
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const urlParams = new URLSearchParams(window.location.search);
    const language = urlParams.get("language") || "ru";

    const cityInput = document.getElementById("cityInput");
    const ethnicityInput = document.getElementById("ethnicityInput");
    const religionInput = document.getElementById("religionInput");
    const maritalStatusInput = document.getElementById("maritalStatusInput");

    let citiesList = [];
    let ethnicitiesList = [];
    let religionsList = [];
    let maritalStatusesList = [];

    // üîπ –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –∏–∑ query-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const fillFormFromQuery = () => {
      const map = {
        name: "input[name='name']",
        age: "input[name='age']",
        gender: "select[name='gender']",
        city_id: "#cityInput",
        height: "input[name='height']",
        weight: "input[name='weight']",
        marital_status_id: "#maritalStatusInput",
        has_children: "select[name='has_children']",
        education: "select[name='education']",
        goal: "select[name='goal']",
        polygamy: "select[name='polygamy']",
        religion_id: "#religionInput",
        religious_level: "select[name='religious_level']",
        ethnicity_id: "#ethnicityInput",
        job: "input[name='job']",
        about: "textarea[name='about']",
        looking_for: "textarea[name='looking_for']"
      };

      for (const [param, selector] of Object.entries(map)) {
        const value = urlParams.get(param);
        if (value !== null && document.querySelector(selector)) {
          document.querySelector(selector).value = value;
        }
      }
    };

    // üîπ –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–æ–≤
    async function loadCities() {
      try {
        const response = await fetch('/cities');
        const cities = await response.json();
        citiesList = cities;

        cityInput.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>';
        cities.forEach(city => {
          const option = document.createElement('option');
          option.value = city.id;
          option.textContent = city[language] || city.ru;
          cityInput.appendChild(option);
        });
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤:", error);
      }
    }

    // üîπ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π
    async function loadEthnicities() {
      try {
        const response = await fetch('/ethnicities');
        const ethnicities = await response.json();
        ethnicitiesList = ethnicities;

        ethnicityInput.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</option>';

        const gender = document.querySelector("select[name='gender']").value || "male";
        const key = `${language}_${gender}`;

        ethnicities.forEach(ethnicity => {
          const option = document.createElement('option');
          option.value = ethnicity.id;
          option.textContent = ethnicity[key] || ethnicity.ru_male;
          ethnicityInput.appendChild(option);
        });
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π:", error);
      }
    }

    // üîπ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ª–∏–≥–∏–π
    async function loadReligions() {
      try {
        const response = await fetch('/religions');
        const religions = await response.json();
        religionsList = religions;

        religionInput.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–ª–∏–≥–∏—é</option>';
        religions.forEach(religion => {
          const option = document.createElement('option');
          option.value = religion.id;
          option.textContent = religion[language] || religion.ru;
          religionInput.appendChild(option);
        });
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–ª–∏–≥–∏–π:", error);
      }
    }

    // üîπ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–º–µ–π–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è
    async function loadMaritalStatuses() {
      try {
        const response = await fetch('/marital_statuses');
        const statuses = await response.json();
        maritalStatusesList = statuses;

        maritalStatusInput.innerHTML = '<option value="">–°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ</option>';

        const gender = document.querySelector("select[name='gender']").value || "male";
        const key = `${language}_${gender}`;

        statuses.forEach(status => {
          const option = document.createElement('option');
          option.value = status.id;
          option.textContent = status[key] || status.ru_male;
          maritalStatusInput.appendChild(option);
        });
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–º–µ–π–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è:", error);
      }
    }

    // üîπ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–ª–∞
    document.querySelector("select[name='gender']").addEventListener("change", () => {
      loadEthnicities();
      loadMaritalStatuses();
    });

    // üîπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    Promise.all([
      loadCities(),
      loadEthnicities(),
      loadReligions(),
      loadMaritalStatuses()
    ]).then(() => {
      fillFormFromQuery();
    });

    // üîπ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(e.target).entries());

      formData.has_children = formData.has_children === "true";
      if (formData.polygamy) {
        formData.polygamy = formData.polygamy === "true";
      }

      const selectedCity = citiesList.find(city => city.id == formData.city);
      const selectedEthnicity = ethnicitiesList.find(ethnicity => ethnicity.id == formData.ethnicity);
      const selectedReligion = religionsList.find(religion => religion.id == formData.religion);

      const payload = {
        action: 'profile_submit',
        ...formData,
        city_name: selectedCity ? selectedCity.ru : formData.city,
        ethnicity_name: selectedEthnicity ? selectedEthnicity.ru_male : formData.ethnicity,
        religion_name: selectedReligion ? selectedReligion.ru : formData.religion,
        user_id: tg.initDataUnsafe?.user?.id
      };

      console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞:", payload);
      tg.sendData(JSON.stringify(payload));
      alert("–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!");
    });
  </script>
</body>
</html>
