<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</title>
  <link rel="stylesheet" href="static/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .button-group button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .button-group button[type="submit"] {
      background-color: #4CAF50;
      color: white;
    }
    
    .button-group button[type="submit"]:hover {
      background-color: #45a049;
    }
    
    .button-group button[type="button"] {
      background-color: #f44336;
      color: white;
    }
    
    .button-group button[type="button"]:hover {
      background-color: #da190b;
    }
    
    @media (max-width: 600px) {
      .button-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 data-i18n="title">üîç –§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h1>
    <form id="filterForm">
      <select name="city" id="cityInput">
        <option value="" data-i18n="city">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
      </select>

      <div class="range-group">
        <label data-i18n="age_lbl">–í–æ–∑—Ä–∞—Å—Ç:</label>
        <div class="range-inputs">
          <input type="number" name="age_from" data-ph="from" placeholder="–û—Ç" min="18" max="100" />
          <span>-</span>
          <input type="number" name="age_to" data-ph="to" placeholder="–î–æ" min="18" max="100" />
        </div>
      </div>

      <div class="range-group">
        <label data-i18n="height_lbl">–†–æ—Å—Ç (—Å–º):</label>
        <div class="range-inputs">
          <input type="number" name="height_from" data-ph="from" placeholder="–û—Ç" min="140" max="220" />
          <span>-</span>
          <input type="number" name="height_to" data-ph="to" placeholder="–î–æ" min="140" max="220" />
        </div>
      </div>

      <div class="range-group">
        <label data-i18n="weight_lbl">–í–µ—Å (–∫–≥):</label>
        <div class="range-inputs">
          <input type="number" name="weight_from" data-ph="from" placeholder="–û—Ç" min="40" max="200" />
          <span>-</span>
          <input type="number" name="weight_to" data-ph="to" placeholder="–î–æ" min="40" max="200" />
        </div>
      </div>

      <select name="has_children">
        <option value="" data-i18n="has_children">–ï—Å—Ç—å –ª–∏ –¥–µ—Ç–∏?</option>
        <option value="true" data-i18n="yes">–î–∞</option>
        <option value="false" data-i18n="no">–ù–µ—Ç</option>
        <option value="any" data-i18n="any">–ù–µ –≤–∞–∂–Ω–æ</option>
      </select>

      <select name="goal">
        <option value="" data-i18n="goal">–¶–µ–ª—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞</option>
        <option value="friendship" data-i18n="friendship">–î—Ä—É–∂–±–∞</option>
        <option value="communication" data-i18n="communication">–û–±—â–µ–Ω–∏–µ</option>
        <option value="serious_relationship" data-i18n="serious_relationship">–°–µ—Ä—å–µ–∑–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è</option>
        <option value="marriage" data-i18n="marriage">–ë—Ä–∞–∫</option>
        <option value="any" data-i18n="any">–ù–µ –≤–∞–∂–Ω–æ</option>
      </select>

      <select name="ethnicity" id="ethnicityInput">
        <option value="" data-i18n="ethnicity">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</option>
      </select>

      <div class="button-group">
        <button type="submit" data-i18n="apply">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
        <button type="button" id="clearFilterBtn" data-i18n="clear">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
      </div>
    </form>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    // –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const language = (urlParams.get("language") || "ru").toLowerCase(); // ru|uz|en
    const userGender = (urlParams.get("gender") || "male").toLowerCase(); // male|female
    const displayGender = userGender === "male" ? "female" : "male"; // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π –ø–æ–ª

    // —ç–ª–µ–º–µ–Ω—Ç—ã
    const cityInput = document.getElementById("cityInput");
    const ethnicityInput = document.getElementById("ethnicityInput");

    // –∫—ç—à–∏
    let citiesList = [];
    let ethnicitiesList = [];

    // i18n —Å –≥–µ–Ω–¥–µ—Ä–Ω—ã–º–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è–º–∏
    const i18n = {
      ru: {
        title: "üîç –§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞",
        city: "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥",
        age_lbl: "–í–æ–∑—Ä–∞—Å—Ç:",
        height_lbl: "–†–æ—Å—Ç (—Å–º):",
        weight_lbl: "–í–µ—Å (–∫–≥):",
        from: "–û—Ç",
        to: "–î–æ",
        has_children: {
          male: "–ï—Å—Ç—å –ª–∏ —É –Ω–µ—ë –¥–µ—Ç–∏?",    // –ú—É–∂—á–∏–Ω–∞ –∏—â–µ—Ç –∂–µ–Ω—â–∏–Ω—É
          female: "–ï—Å—Ç—å –ª–∏ —É –Ω–µ–≥–æ –¥–µ—Ç–∏?"  // –ñ–µ–Ω—â–∏–Ω–∞ –∏—â–µ—Ç –º—É–∂—á–∏–Ω—É
        },
        yes: "–î–∞",
        no: "–ù–µ—Ç",
        any: "–ù–µ –≤–∞–∂–Ω–æ",
        goal: "–¶–µ–ª—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞",
        friendship: "–î—Ä—É–∂–±–∞",
        communication: "–û–±—â–µ–Ω–∏–µ",
        serious_relationship: "–°–µ—Ä—å–µ–∑–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è",
        marriage: "–ë—Ä–∞–∫",
        ethnicity: "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å",
        apply: "‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä",
        clear: "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä",
        sent: "–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!",
        error: "–û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ."
      },
      uz: {
        title: "üîç “ö–∏–¥–∏—Ä—É–≤ —Ñ–∏–ª—å—Ç—Ä–ª–∞—Ä–∏",
        city: "–®–∞“≥–∞—Ä–Ω–∏ —Ç–∞–Ω–ª–∞–Ω–≥",
        age_lbl: "–Å—à:",
        height_lbl: "–ë—û–π–∏ (—Å–º):",
        weight_lbl: "–í–∞–∑–Ω–∏ (–∫–≥):",
        from: "–î–∞–Ω",
        to: "–ì–∞—á–∞",
        has_children: {
          male: "–£–Ω–∏–Ω–≥ —Ñ–∞—Ä–∑–∞–Ω–¥–∏ –±–æ—Ä–º–∏?",     // –≠—Ä–∫–∞–∫ –∞—ë–ª –∏–∑–ª–∞–π–¥–∏
          female: "–£–Ω–∏–Ω–≥ —Ñ–∞—Ä–∑–∞–Ω–¥–∏ –±–æ—Ä–º–∏?"    // –ê—ë–ª —ç—Ä–∫–∞–∫ –∏–∑–ª–∞–π–¥–∏
        },
        yes: "“≤–∞",
        no: "–ô—û“õ",
        any: "–ú—É“≥–∏–º —ç–º–∞—Å",
        goal: "–¢–∞–Ω–∏—à—É–≤ –º–∞“õ—Å–∞–¥–∏",
        friendship: "–î—û—Å—Ç–ª–∏–∫",
        communication: "–ú—É–ª–æ“õ–æ—Ç",
        serious_relationship: "–ñ–∏–¥–¥–∏–π –º—É–Ω–æ—Å–∞–±–∞—Ç",
        marriage: "–ù–∏–∫–æ“≥",
        ethnicity: "–ú–∏–ª–ª–∞—Ç–Ω–∏ —Ç–∞–Ω–ª–∞–Ω–≥",
        apply: "‚úÖ –§–∏–ª—å—Ç—Ä–Ω–∏ “õ—û–ª–ª–∞—à",
        clear: "üóëÔ∏è –§–∏–ª—å—Ç—Ä–Ω–∏ —Ç–æ–∑–∞–ª–∞—à",
        sent: "–ú–∞—ä–ª—É–º–æ—Ç–ª–∞—Ä —é–±–æ—Ä–∏–ª–¥–∏!",
        error: "–•–∞—Ç–æ. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç–Ω–∏ —Ç–µ–∫—à–∏—Ä–∏–Ω–≥."
      },
      en: {
        title: "üîç Search filters",
        city: "Select a city",
        age_lbl: "Age:",
        height_lbl: "Height (cm):",
        weight_lbl: "Weight (kg):",
        from: "From",
        to: "To",
        has_children: {
          male: "Does she have children?",   // –ú—É–∂—á–∏–Ω–∞ –∏—â–µ—Ç –∂–µ–Ω—â–∏–Ω—É
          female: "Does he have children?"  // –ñ–µ–Ω—â–∏–Ω–∞ –∏—â–µ—Ç –º—É–∂—á–∏–Ω—É
        },
        yes: "Yes",
        no: "No",
        any: "Any",
        goal: "Dating goal",
        friendship: "Friendship",
        communication: "Communication",
        serious_relationship: "Serious relationship",
        marriage: "Marriage",
        ethnicity: "Select nationality",
        apply: "‚úÖ Apply filter",
        clear: "üóëÔ∏è Clear filter",
        sent: "Data sent!",
        error: "Error. Check your connection."
      }
    };
    const T = (key) => {
      const value = (i18n[language] && i18n[language][key]) || i18n.ru[key] || key;
      // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º —Å –≥–µ–Ω–¥–µ—Ä–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
      if (typeof value === 'object' && value !== null) {
        return value[userGender] || value.male || key;
      }
      return value;
    };

    function applyTranslations() {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        el.textContent = T(el.getAttribute("data-i18n"));
      });
      document.querySelectorAll("[data-ph]").forEach(el => {
        el.placeholder = T(el.getAttribute("data-ph"));
      });
      document.title = T("title");
      document.documentElement.setAttribute("lang", language);
    }

    // helper –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –ø–æ —è–∑—ã–∫—É
    function localizedCityName(c) {
      return c[language] || c.ru || c.en || c.uz || String(c.id);
    }
    function localizedEthnicityName(e) {
      const key = `${language}_${displayGender}`; // –Ω–∞–ø—Ä. ru_female
      return e[key] || e[`ru_${displayGender}`] || e[`en_${displayGender}`] || e[`uz_${displayGender}`] || String(e.id);
    }

    // –∑–∞–≥—Ä—É–∑–∫–∞
    async function loadCities() {
      try {
        const response = await fetch('/cities');
        const cities = await response.json();
        citiesList = cities;

        cityInput.innerHTML = `<option value="">${T("city")}</option>`;
        cities.forEach(city => {
          const opt = document.createElement('option');
          opt.value = city.id;
          opt.textContent = localizedCityName(city);
          cityInput.appendChild(opt);
        });

        const cityFromUrl = urlParams.get("city");
        if (cityFromUrl) cityInput.value = cityFromUrl;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤:", err);
      }
    }

    async function loadEthnicities() {
      try {
        const response = await fetch('/ethnicities');
        const ethnicities = await response.json();
        ethnicitiesList = ethnicities;

        ethnicityInput.innerHTML = `<option value="">${T("ethnicity")}</option>`;
        ethnicities.forEach(e => {
          const opt = document.createElement('option');
          opt.value = e.id;
          opt.textContent = localizedEthnicityName(e);
          ethnicityInput.appendChild(opt);
        });

        const ethFromUrl = urlParams.get("ethnicity");
        if (ethFromUrl) ethnicityInput.value = ethFromUrl;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π:", err);
      }
    }

    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    (async () => {
      applyTranslations();
      await loadCities();
      await loadEthnicities();

      // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ URL
      const setVal = (name) => { const el = document.getElementsByName(name)[0]; if (el) el.value = urlParams.get(name) || ""; };
      ["age_from","age_to","height_from","height_to","weight_from","weight_to","goal","has_children"].forEach(setVal);
      // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî –µ—Å–ª–∏ option[0] –ø–µ—Ä–µ–ø–∏—Å–∞–ª—Å—è
      applyTranslations();
    })();

    // –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById("filterForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(e.target).entries());

      // –±—É–ª–µ–≤—ã/any
      if (formData.has_children === "true") formData.has_children = true;
      else if (formData.has_children === "false") formData.has_children = false;
      else if (formData.has_children === "any") formData.has_children = "any";
      if (!formData.goal) formData.goal = ""; // –ø—É—Å—Ç–æ–µ = –Ω–µ –≤—ã–±—Ä–∞–Ω–æ; "any" ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

      // –Ω–∞–π–¥–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
      const city = citiesList.find(c => String(c.id) === String(formData.city));
      const eth = ethnicitiesList.find(eh => String(eh.id) === String(formData.ethnicity));

      const payload = {
        action: "filter_submit",
        ...formData,
        city_name: city ? localizedCityName(city) : formData.city,
        ethnicity_name: eth ? localizedEthnicityName(eth) : formData.ethnicity,
        ui_language: language,
        target_gender: displayGender, // –∫–æ–≥–æ –∏—â–µ–º, –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        user_id: tg?.initDataUnsafe?.user?.id
      };

      try {
        console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞:", payload);
        tg?.sendData(JSON.stringify(payload));
        alert(T("sent"));
      } catch (err) {
        console.error(err);
        alert(T("error"));
      }
    });

    // —Ñ—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞
    function clearFilter() {
      // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
      document.getElementById("filterForm").reset();
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º select —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      cityInput.value = "";
      ethnicityInput.value = "";
      
      // –û—á–∏—â–∞–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
      const numberFields = ["age_from", "age_to", "height_from", "height_to", "weight_from", "weight_to"];
      numberFields.forEach(fieldName => {
        const field = document.getElementsByName(fieldName)[0];
        if (field) field.value = "";
      });
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º select –ø–æ–ª—è
      const selectFields = ["goal", "has_children"];
      selectFields.forEach(fieldName => {
        const field = document.getElementsByName(fieldName)[0];
        if (field) field.selectedIndex = 0;
      });
      
      console.log("–§–∏–ª—å—Ç—Ä –æ—á–∏—â–µ–Ω");
    }

    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
    document.getElementById("clearFilterBtn").addEventListener("click", clearFilter);
  </script>
</body>
</html>
