<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</title>
  <link rel="stylesheet" href="static/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <h1>üîç –§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h1>
    <form id="filterForm">
      <select name="city" id="cityInput">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
      </select>
      <div class="range-group">
        <label>–í–æ–∑—Ä–∞—Å—Ç:</label>
        <div class="range-inputs">
          <input type="number" name="age_from" placeholder="–û—Ç" min="18" max="100" />
          <span>-</span>
          <input type="number" name="age_to" placeholder="–î–æ" min="18" max="100" />
        </div>
      </div>

      <div class="range-group">
        <label>–†–æ—Å—Ç (—Å–º):</label>
        <div class="range-inputs">
          <input type="number" name="height_from" placeholder="–û—Ç" min="140" max="220" />
          <span>-</span>
          <input type="number" name="height_to" placeholder="–î–æ" min="140" max="220" />
        </div>
      </div>

      <div class="range-group">
        <label>–í–µ—Å (–∫–≥):</label>
        <div class="range-inputs">
          <input type="number" name="weight_from" placeholder="–û—Ç" min="40" max="200" />
          <span>-</span>
          <input type="number" name="weight_to" placeholder="–î–æ" min="40" max="200" />
        </div>
      </div>

      <select name="has_children">
        <option value="">–ï—Å—Ç—å –ª–∏ –¥–µ—Ç–∏?</option>
        <option value="true">–î–∞</option>
        <option value="false">–ù–µ—Ç</option>
        <option value="any">–ù–µ –≤–∞–∂–Ω–æ</option>
      </select>

      <select name="goal">
        <option value="">–¶–µ–ª—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞</option>
        <option value="friendship">–î—Ä—É–∂–±–∞</option>
        <option value="communication">–û–±—â–µ–Ω–∏–µ</option>
        <option value="serious_relationship">–°–µ—Ä—å–µ–∑–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è</option>
        <option value="marriage">–ë—Ä–∞–∫</option>
        <option value="any">–ù–µ –≤–∞–∂–Ω–æ</option>
      </select>

       <select name="ethnicity" id="ethnicityInput">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</option>
      </select>

      <button type="submit">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
    </form>
  </div>
  <!-- –í–°–¢–ê–í–õ–ï–ù–ù–´–ô –°–ö–†–ò–ü–¢ -->
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const urlParams = new URLSearchParams(window.location.search);
    const language = urlParams.get("language") || "ru"; // fallback

    const cityInput = document.getElementById("cityInput");
    const ethnicityInput = document.getElementById("ethnicityInput");

    let citiesList = [];
    let ethnicitiesList = [];

    // üîπ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –∏–∑ API
    async function loadCities() {
      try {
        const response = await fetch('/cities');
        const cities = await response.json();
        citiesList = cities;
        
        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
        cityInput.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥–∞ –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        cities.forEach(city => {
          const option = document.createElement('option');
          option.value = city.id;
          option.textContent = city[language] || city.ru; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
          cityInput.appendChild(option);
        });
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤:", error);
      }
    }

    async function loadEthnicities() {
      try {
        const response = await fetch('/ethnicities');
        const ethnicities = await response.json();
        ethnicitiesList = ethnicities;

        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
        ethnicityInput.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</option>';

        // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥–∞ –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        ethnicities.forEach(ethnicity => {
          const option = document.createElement('option');
          option.value = ethnicity.id;
          option.textContent = ethnicity[language] || ethnicity.ru; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
          ethnicityInput.appendChild(option);
        });
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π:", error);
      }
    }

    // üîπ –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadCities();
    loadEthnicities()

    // üîπ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById("filterForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = Object.fromEntries(new FormData(e.target).entries());

      formData.has_children = formData.has_children === "true";
      if (formData.polygamy) {
        formData.polygamy = formData.polygamy === "true";
      }

      // –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥ –ø–æ ID
      const selectedCity = citiesList.find(city => city.id == formData.city);

      const selectedEthnicity = ethnicitiesList.find(ethnicity => ethnicity.id == formData.ethnicity);
      
      const payload = {
        action: 'filter_submit',
        ...formData,
        city_name: selectedCity ? selectedCity.ru : formData.city, // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
        ethnicity_name: selectedEthnicity ? selectedEthnicity.ru : formData.ethnicity, // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
        user_id: tg.initDataUnsafe?.user?.id,
      };

      console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞:", payload);
      tg.sendData(JSON.stringify(payload));
      alert("–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!");
    });
  </script>
</body>
</html> 