<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</title>
  <link rel="stylesheet" href="static/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <h1 data-i18n="title">üîç –§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h1>
    <form id="filterForm">
      <select name="city" id="cityInput">
        <option value="" data-i18n="city">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
      </select>

      <div class="range-group">
        <label data-i18n="age_lbl">–í–æ–∑—Ä–∞—Å—Ç:</label>
        <div class="range-inputs">
          <input type="number" name="age_from" data-ph="from" placeholder="–û—Ç" min="18" max="100" />
          <span>-</span>
          <input type="number" name="age_to" data-ph="to" placeholder="–î–æ" min="18" max="100" />
        </div>
      </div>

      <div class="range-group">
        <label data-i18n="height_lbl">–†–æ—Å—Ç (—Å–º):</label>
        <div class="range-inputs">
          <input type="number" name="height_from" data-ph="from" placeholder="–û—Ç" min="140" max="220" />
          <span>-</span>
          <input type="number" name="height_to" data-ph="to" placeholder="–î–æ" min="140" max="220" />
        </div>
      </div>

      <div class="range-group">
        <label data-i18n="weight_lbl">–í–µ—Å (–∫–≥):</label>
        <div class="range-inputs">
          <input type="number" name="weight_from" data-ph="from" placeholder="–û—Ç" min="40" max="200" />
          <span>-</span>
          <input type="number" name="weight_to" data-ph="to" placeholder="–î–æ" min="40" max="200" />
        </div>
      </div>

      <select name="has_children">
        <option value="" data-i18n="has_children">–ï—Å—Ç—å –ª–∏ –¥–µ—Ç–∏?</option>
        <option value="true" data-i18n="yes">–î–∞</option>
        <option value="false" data-i18n="no">–ù–µ—Ç</option>
        <option value="any" data-i18n="any">–ù–µ –≤–∞–∂–Ω–æ</option>
      </select>

      <select name="goal">
        <option value="" data-i18n="goal">–¶–µ–ª—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞</option>
        <option value="friendship" data-i18n="friendship">–î—Ä—É–∂–±–∞</option>
        <option value="communication" data-i18n="communication">–û–±—â–µ–Ω–∏–µ</option>
        <option value="serious_relationship" data-i18n="serious_relationship">–°–µ—Ä—å–µ–∑–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è</option>
        <option value="marriage" data-i18n="marriage">–ë—Ä–∞–∫</option>
        <option value="any" data-i18n="any">–ù–µ –≤–∞–∂–Ω–æ</option>
      </select>

      <select name="ethnicity" id="ethnicityInput">
        <option value="" data-i18n="ethnicity">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</option>
      </select>

      <button type="submit" data-i18n="apply">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
    </form>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    // –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const language = (urlParams.get("language") || "ru").toLowerCase(); // ru|uz|en
    const userGender = (urlParams.get("gender") || "male").toLowerCase(); // male|female
    const displayGender = userGender === "male" ? "female" : "male"; // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π –ø–æ–ª

    // —ç–ª–µ–º–µ–Ω—Ç—ã
    const cityInput = document.getElementById("cityInput");
    const ethnicityInput = document.getElementById("ethnicityInput");

    // –∫—ç—à–∏
    let citiesList = [];
    let ethnicitiesList = [];

    // i18n
    const i18n = {
      ru: {
        title: "üîç –§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞",
        city: "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥",
        age_lbl: "–í–æ–∑—Ä–∞—Å—Ç:",
        height_lbl: "–†–æ—Å—Ç (—Å–º):",
        weight_lbl: "–í–µ—Å (–∫–≥):",
        from: "–û—Ç",
        to: "–î–æ",
        has_children: "–ï—Å—Ç—å –ª–∏ –¥–µ—Ç–∏?",
        yes: "–î–∞",
        no: "–ù–µ—Ç",
        any: "–ù–µ –≤–∞–∂–Ω–æ",
        goal: "–¶–µ–ª—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞",
        friendship: "–î—Ä—É–∂–±–∞",
        communication: "–û–±—â–µ–Ω–∏–µ",
        serious_relationship: "–°–µ—Ä—å–µ–∑–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è",
        marriage: "–ë—Ä–∞–∫",
        ethnicity: "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å",
        apply: "‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä",
        sent: "–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!",
        error: "–û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ."
      },
      uz: {
        title: "üîç Qidiruv filtrlari",
        city: "Shaharni tanlang",
        age_lbl: "Yosh:",
        height_lbl: "Bo‚Äòyi (sm):",
        weight_lbl: "Vazni (kg):",
        from: "Dan",
        to: "Gacha",
        has_children: "Farzand bormi?",
        yes: "Ha",
        no: "Yo‚Äòq",
        any: "Muhim emas",
        goal: "Tanishuv maqsadi",
        friendship: "Do‚Äòstlik",
        communication: "Muloqot",
        serious_relationship: "Jiddiy munosabat",
        marriage: "Nikoh",
        ethnicity: "Millatni tanlang",
        apply: "‚úÖ Filtrni qo‚Äòllash",
        sent: "Ma'lumotlar yuborildi!",
        error: "Xato. Internetni tekshiring."
      },
      en: {
        title: "üîç Search filters",
        city: "Select a city",
        age_lbl: "Age:",
        height_lbl: "Height (cm):",
        weight_lbl: "Weight (kg):",
        from: "From",
        to: "To",
        has_children: "Do they have children?",
        yes: "Yes",
        no: "No",
        any: "Any",
        goal: "Dating goal",
        friendship: "Friendship",
        communication: "Communication",
        serious_relationship: "Serious relationship",
        marriage: "Marriage",
        ethnicity: "Select nationality",
        apply: "‚úÖ Apply filter",
        sent: "Data sent!",
        error: "Error. Check your connection."
      }
    };
    const T = (k) => (i18n[language] && i18n[language][k]) || i18n.ru[k] || k;

    function applyTranslations() {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        el.textContent = T(el.getAttribute("data-i18n"));
      });
      document.querySelectorAll("[data-ph]").forEach(el => {
        el.placeholder = T(el.getAttribute("data-ph"));
      });
      document.title = T("title");
      document.documentElement.setAttribute("lang", language);
    }

    // helper –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –ø–æ —è–∑—ã–∫—É
    function localizedCityName(c) {
      return c[language] || c.ru || c.en || c.uz || String(c.id);
    }
    function localizedEthnicityName(e) {
      const key = `${language}_${displayGender}`; // –Ω–∞–ø—Ä. ru_female
      return e[key] || e[`ru_${displayGender}`] || e[`en_${displayGender}`] || e[`uz_${displayGender}`] || String(e.id);
    }

    // –∑–∞–≥—Ä—É–∑–∫–∞
    async function loadCities() {
      try {
        const response = await fetch('/cities');
        const cities = await response.json();
        citiesList = cities;

        cityInput.innerHTML = `<option value="">${T("city")}</option>`;
        cities.forEach(city => {
          const opt = document.createElement('option');
          opt.value = city.id;
          opt.textContent = localizedCityName(city);
          cityInput.appendChild(opt);
        });

        const cityFromUrl = urlParams.get("city");
        if (cityFromUrl) cityInput.value = cityFromUrl;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤:", err);
      }
    }

    async function loadEthnicities() {
      try {
        const response = await fetch('/ethnicities');
        const ethnicities = await response.json();
        ethnicitiesList = ethnicities;

        ethnicityInput.innerHTML = `<option value="">${T("ethnicity")}</option>`;
        ethnicities.forEach(e => {
          const opt = document.createElement('option');
          opt.value = e.id;
          opt.textContent = localizedEthnicityName(e);
          ethnicityInput.appendChild(opt);
        });

        const ethFromUrl = urlParams.get("ethnicity");
        if (ethFromUrl) ethnicityInput.value = ethFromUrl;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π:", err);
      }
    }

    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    (async () => {
      applyTranslations();
      await loadCities();
      await loadEthnicities();

      // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ URL
      const setVal = (name) => { const el = document.getElementsByName(name)[0]; if (el) el.value = urlParams.get(name) || ""; };
      ["age_from","age_to","height_from","height_to","weight_from","weight_to","goal","has_children"].forEach(setVal);
      // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî –µ—Å–ª–∏ option[0] –ø–µ—Ä–µ–ø–∏—Å–∞–ª—Å—è
      applyTranslations();
    })();

    // –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById("filterForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(e.target).entries());

      // –±—É–ª–µ–≤—ã/any
      if (formData.has_children === "true") formData.has_children = true;
      else if (formData.has_children === "false") formData.has_children = false;
      else if (formData.has_children === "any") formData.has_children = "any";
      if (!formData.goal) formData.goal = ""; // –ø—É—Å—Ç–æ–µ = –Ω–µ –≤—ã–±—Ä–∞–Ω–æ; "any" ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

      // –Ω–∞–π–¥–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
      const city = citiesList.find(c => String(c.id) === String(formData.city));
      const eth = ethnicitiesList.find(eh => String(eh.id) === String(formData.ethnicity));

      const payload = {
        action: "filter_submit",
        ...formData,
        city_name: city ? localizedCityName(city) : formData.city,
        ethnicity_name: eth ? localizedEthnicityName(eth) : formData.ethnicity,
        ui_language: language,
        target_gender: displayGender, // –∫–æ–≥–æ –∏—â–µ–º, –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        user_id: tg?.initDataUnsafe?.user?.id
      };

      try {
        console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞:", payload);
        tg?.sendData(JSON.stringify(payload));
        alert(T("sent"));
      } catch (err) {
        console.error(err);
        alert(T("error"));
      }
    });
  </script>
</body>
</html>
