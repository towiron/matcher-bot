from aiogram.exceptions import TelegramForbiddenError, TelegramBadRequest, TelegramNetworkError, TelegramAPIError

from app.keyboards.default.base import search_kb
from app.keyboards.inline.admin import block_user_ikb
from app.text import message_text as mt
from data.config import MODERATOR_GROUP
from database.models.profile import ProfileModel
from database.models.user import UserModel
from database.services import City, Ethnicity, Religion
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram.types import ReplyKeyboardMarkup, InlineKeyboardMarkup
from app.keyboards.inline.contact import contact_user_ikb
from database.services import User

from database.services.marital_status import MaritalStatus
from loader import bot
from utils.logging import logger

async def update_user_username_from_telegram(session: AsyncSession, user_id: int) -> str | None:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π username –∏–ª–∏ None, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å.
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ Telegram
        chat_member = await bot.get_chat_member(chat_id=user_id, user_id=user_id)
        if chat_member and chat_member.user and chat_member.user.username:
            new_username = chat_member.user.username
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            user_obj = await User.get_by_id(session, user_id)
            if user_obj and user_obj.username != new_username:
                # –û–±–Ω–æ–≤–ª—è–µ–º username –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                await User.update_username(session, user_id, new_username)
                logger.log("USERNAME_UPDATE", f"–û–±–Ω–æ–≤–ª–µ–Ω username –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {user_obj.username} -> {new_username}")
            
            return new_username
        else:
            # –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç username
            user_obj = await User.get_by_id(session, user_id)
            if user_obj and user_obj.username is not None:
                # –û—á–∏—â–∞–µ–º username –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                await User.update_username(session, user_id, None)
                logger.log("USERNAME_UPDATE", f"–û—á–∏—â–µ–Ω username –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            
            return None
            
    except TelegramForbiddenError:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ {user_id}: –±–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        return None
    except TelegramBadRequest as e:
        logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ {user_id}: {e}")
        return None
    except Exception as e:
        logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ username –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
        return None

async def send_profile(session: AsyncSession, chat_id: int, profile: ProfileModel, user_language: str = "ru", reply_markup: ReplyKeyboardMarkup | InlineKeyboardMarkup | None = None) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –≤ —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ—Ñ–∏–ª—å"""
    profile_text = await format_profile_text(session, profile, user_language)

    await bot.send_message(
        chat_id=chat_id,
        text=profile_text,
        parse_mode="HTML",
        reply_markup=reply_markup,
    )


async def display_filtered_profile(session: AsyncSession, chat_id: int, profile: ProfileModel, user_language: str = "ru", current_user_id: int = None) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–æ—à–ª–∏ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –∏ —É–º–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞)"""
    text = await format_candidate_profile_text(session, profile, user_language)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–∞–≤–∞–ª –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —à–∞–Ω—Å —ç—Ç–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é
    reply_markup = search_kb()
    
    if current_user_id and profile.id != current_user_id:
        from database.services import Match
        from app.keyboards.inline.contact import contact_user_ikb
        from utils.logging import logger
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–∞–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —à–∞–Ω—Å —ç—Ç–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é
        existing_match = await Match.get(session, receiver_id=profile.id, sender_id=current_user_id)
        
        if existing_match:
            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –¥–∞–ª —à–∞–Ω—Å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –±–µ–∑ "–¥–∞—Ç—å —à–∞–Ω—Å"
            from app.keyboards.default.base import search_kb_after_chance
            reply_markup = search_kb_after_chance()
            # –î–æ–±–∞–≤–ª—è–µ–º inline-–∫–Ω–æ–ø–∫—É –¥–ª—è —Å–≤—è–∑–∏
            try:
                # –û–±–Ω–æ–≤–ª—è–µ–º username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–Ω–æ–ø–∫–∏
                updated_username = await update_user_username_from_telegram(session, profile.id)
                
                if updated_username:
                    profile_link = f"https://t.me/{updated_username}"
                else:
                    profile_link = f"tg://user?id={profile.id}"
                
                # –°–æ–∑–¥–∞–µ–º inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Å–≤—è–∑–∏
                inline_markup = contact_user_ikb(user_language, profile_link)

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
                await bot.send_message(
                    chat_id=chat_id,
                    text=text,
                    parse_mode="HTML",
                    reply_markup=reply_markup,
                    disable_web_page_preview=True,
                )
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å inline-–∫–Ω–æ–ø–∫–æ–π —Å–≤—è–∑–∏
                await bot.send_message(
                    chat_id=chat_id,
                    text="üí¨ –í—ã —É–∂–µ –¥–∞–ª–∏ —à–∞–Ω—Å —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ú–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∏–º:",
                    reply_markup=inline_markup,
                )
                return
                
            except Exception as e:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–Ω–æ–ø–∫—É —Å–≤—è–∑–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                await bot.send_message(
                    chat_id=chat_id,
                    text=text,
                    parse_mode="HTML",
                    reply_markup=reply_markup,
                    disable_web_page_preview=True,
                )
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º –∞–∫–∫–∞—É–Ω—Ç–µ
                await bot.send_message(
                    chat_id=chat_id,
                    text="üîí –£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç, –Ω–æ –æ–Ω –º–æ–∂–µ—Ç —Å–≤—è–∑–∞—Ç—å—Å—è —Å –≤–∞–º–∏ —Å–∞–º, –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –≤–∑–∞–∏–º–Ω–æ—Å—Ç—å—é –Ω–∞ –≤–∞—à —à–∞–Ω—Å.",
                    reply_markup=reply_markup,
                )
                return

    await bot.send_message(
        chat_id=chat_id,
        text=text,
        parse_mode="HTML",
        reply_markup=reply_markup,
        disable_web_page_preview=True,
    )


async def complaint_to_profile(
    session: AsyncSession, complainant: UserModel, reason: str, complaint_user: UserModel
) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –≥—Ä—É–ø–ø—É –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∞–Ω–∫–µ—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ –ø—Ä–∏—à–ª–∞ –∂–∞–ª–æ–±–∞."""
    if not MODERATOR_GROUP:
        return

    if not complaint_user.profile:
        logger.warning(f"–ñ–∞–ª–æ–±–∞ –Ω–∞ {complaint_user.id}, –Ω–æ –ø—Ä–æ—Ñ–∏–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.")
        return

    # 1) —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∞–º –ø—Ä–æ—Ñ–∏–ª—å
    try:
        await send_profile(session, MODERATOR_GROUP, complaint_user.profile, complaint_user.language)
    except TelegramForbiddenError:
        logger.error("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫–æ–π –≥—Ä—É–ø–ø–µ (–±–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω/—É–¥–∞–ª—ë–Ω).")
        return
    except TelegramBadRequest as e:
        logger.error(f"BadRequest –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–æ—Ñ–∏–ª—è: {e!r}")
        return
    except TelegramNetworkError as e:
        logger.warning(f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–æ—Ñ–∏–ª—è: {e!r}")
        return
    except TelegramAPIError as e:
        logger.exception(f"–û—à–∏–±–∫–∞ Telegram API –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–æ—Ñ–∏–ª—è: {e!r}")
        return

    # 2) –∑–∞—Ç–µ–º —Ç–µ–∫—Å—Ç —Å –∫–Ω–æ–ø–∫–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    text = mt.REPORT_TO_USER.format(
        complainant.id,
        complainant.username,
        complaint_user.id,
        complaint_user.username,
        reason,
    )

    try:
        await bot.send_message(
            chat_id=MODERATOR_GROUP,
            text=text,
            reply_markup=block_user_ikb(
                id=complaint_user.id,
                username=complaint_user.username,
            ),
        )
    except TelegramForbiddenError:
        logger.error("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫–æ–π –≥—Ä—É–ø–ø–µ (–±–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω/—É–¥–∞–ª—ë–Ω).")
    except TelegramBadRequest as e:
        logger.error(f"BadRequest –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫—É—é –≥—Ä—É–ø–ø—É: {e!r}")
    except TelegramNetworkError as e:
        logger.warning(f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫—É—é –≥—Ä—É–ø–ø—É: {e!r}")
    except TelegramAPIError as e:
        logger.exception(f"–û—à–∏–±–∫–∞ Telegram API –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫—É—é –≥—Ä—É–ø–ø—É: {e!r}")


async def format_profile_text(session: AsyncSession, profile: ProfileModel, user_language: str = "ru") -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"""

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ message_text
    gender_map = {
        "male": mt.KB_GENDER_MALE,
        "female": mt.KB_GENDER_FEMALE,
    }

    education_map = {
        "primary": mt.KB_EDUCATION_SECONDARY,  # –∏–ª–∏ –¥–æ–±–∞–≤—å KB_EDUCATION_PRIMARY
        "secondary": mt.KB_EDUCATION_SECONDARY,
        "incomplete_higher": mt.KB_EDUCATION_INCOMPLETE_HIGHER,
        "higher": mt.KB_EDUCATION_HIGHER,
    }

    goal_map = {
        "friendship": mt.KB_GOAL_FRIENDSHIP,
        "communication": mt.KB_GOAL_COMMUNICATION,
        "marriage": mt.KB_GOAL_MARRIAGE,
        "serious_relationship": mt.KB_GOAL_SERIOUS_RELATIONSHIP,
    }

    religious_level_map = {
        "low": mt.KB_RELIGIOSITY_LOW,
        "medium": mt.KB_RELIGIOSITY_MEDIUM,
        "high": mt.KB_RELIGIOSITY_HIGH,
        "strict": mt.KB_RELIGIOSITY_STRICT,
        "none": mt.KB_RELIGIOSITY_NONE,
    }

    marital_status_obj = await MaritalStatus.get_by_id(session, id=profile.marital_status_id)
    marital_status_name = get_gendered_field_value(marital_status_obj, user_language, profile.gender)

    city_obj = await City.get_by_id(session, id=profile.city_id)
    city_name = city_obj.en
    if city_obj:
        match user_language:
            case "uz":
                city_name = city_obj.uz
            case "en":
                city_name = city_obj.en
            case "ru":
                city_name = city_obj.ru

    ethnicity_obj = await Ethnicity.get_by_id(session, id=profile.ethnicity_id)
    ethnicity_name = get_gendered_field_value(ethnicity_obj, user_language, profile.gender)

    religion_obj = await Religion.get_by_id(session, id=profile.religion_id)
    religion_name = religion_obj.en
    if religion_obj:
        match user_language:
            case "uz":
                religion_name = religion_obj.uz
            case "en":
                religion_name = religion_obj.en
            case "ru":
                religion_name = religion_obj.ru

    # –°–±–æ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–∞
    profile_text = f"""
{mt.PROFILE_NAME.format(profile.name)}
{mt.PROFILE_AGE.format(profile.age)}
{mt.PROFILE_GENDER.format(gender_map.get(profile.gender, profile.gender))}
{mt.PROFILE_CITY.format(city_name)}
{mt.PROFILE_HEIGHT.format(profile.height)}
{mt.PROFILE_WEIGHT.format(profile.weight)}

{mt.PROFILE_MARITAL_STATUS.format(marital_status_name)}
{mt.PROFILE_HAS_CHILDREN.format(mt.PROFILE_YES if profile.has_children else mt.PROFILE_NO)}"""

    job_text = profile.job if profile.job else "-"
    profile_text += f"""
{mt.PROFILE_EDUCATION.format(education_map.get(profile.education, profile.education))}
{mt.PROFILE_JOB.format(job_text)}
{mt.PROFILE_GOAL.format(goal_map.get(profile.goal, profile.goal))}
{mt.PROFILE_RELIGION.format(religion_name)}"""

    if profile.religious_level:
        profile_text += f"\n{mt.PROFILE_RELIGIOUS_LEVEL.format(religious_level_map.get(profile.religious_level))}"

    profile_text += f"""
{mt.PROFILE_ETHNICITY.format(ethnicity_name)}"""

    about_text = profile.about if profile.about else "-"
    looking_for_text = profile.looking_for if profile.looking_for else "-"

    profile_text += f"""
{mt.PROFILE_ABOUT.format(about_text)}"""
    profile_text += f"""
{mt.PROFILE_LOOKING_FOR.format(looking_for_text)}"""

    return profile_text

async def format_candidate_profile_text(session: AsyncSession, profile: ProfileModel, user_language: str = "ru") -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"""

    education_map = {
        "primary": mt.KB_EDUCATION_SECONDARY,  # –∏–ª–∏ –¥–æ–±–∞–≤—å KB_EDUCATION_PRIMARY
        "secondary": mt.KB_EDUCATION_SECONDARY,
        "incomplete_higher": mt.KB_EDUCATION_INCOMPLETE_HIGHER,
        "higher": mt.KB_EDUCATION_HIGHER,
    }

    goal_map = {
        "friendship": mt.KB_GOAL_FRIENDSHIP,
        "communication": mt.KB_GOAL_COMMUNICATION,
        "marriage": mt.KB_GOAL_MARRIAGE,
        "serious_relationship": mt.KB_GOAL_SERIOUS_RELATIONSHIP,
    }

    religious_level_map = {
        "low": mt.KB_RELIGIOSITY_LOW,
        "medium": mt.KB_RELIGIOSITY_MEDIUM,
        "high": mt.KB_RELIGIOSITY_HIGH,
        "strict": mt.KB_RELIGIOSITY_STRICT,
        "none": mt.KB_RELIGIOSITY_NONE,
    }

    marital_status_obj = await MaritalStatus.get_by_id(session, id=profile.marital_status_id)
    marital_status_name = get_gendered_field_value(marital_status_obj, user_language, profile.gender)

    city_obj = await City.get_by_id(session, id=profile.city_id)
    city_name = city_obj.en
    if city_obj:
        match user_language:
            case "uz":
                city_name = city_obj.uz
            case "en":
                city_name = city_obj.en
            case "ru":
                city_name = city_obj.ru

    ethnicity_obj = await Ethnicity.get_by_id(session, id=profile.ethnicity_id)
    ethnicity_name = get_gendered_field_value(ethnicity_obj, user_language, profile.gender)

    religion_obj = await Religion.get_by_id(session, id=profile.religion_id)
    religion_name = religion_obj.en
    if religion_obj:
        match user_language:
            case "uz":
                religion_name = religion_obj.uz
            case "en":
                religion_name = religion_obj.en
            case "ru":
                religion_name = religion_obj.ru

    # –°–±–æ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–∞
    profile_text = f"""
{mt.PROFILE_NAME.format(profile.name)}
{mt.PROFILE_AGE.format(profile.age)}
{mt.PROFILE_CITY.format(city_name)}
{mt.PROFILE_HEIGHT.format(profile.height)}
{mt.PROFILE_WEIGHT.format(profile.weight)}

{mt.PROFILE_MARITAL_STATUS.format(marital_status_name)}
{mt.PROFILE_HAS_CHILDREN.format(mt.PROFILE_YES if profile.has_children else mt.PROFILE_NO)}"""

    job_text = profile.job if profile.job else "-"
    profile_text += f"""
{mt.PROFILE_EDUCATION.format(education_map.get(profile.education, profile.education))}
{mt.PROFILE_JOB.format(job_text)}
{mt.PROFILE_GOAL.format(goal_map.get(profile.goal, profile.goal))}
{mt.PROFILE_RELIGION.format(religion_name)}"""

    if profile.religious_level:
        profile_text += f"\n{mt.PROFILE_RELIGIOUS_LEVEL.format(religious_level_map.get(profile.religious_level))}"

    profile_text += f"""
{mt.PROFILE_ETHNICITY.format(ethnicity_name)}"""
    about_text = profile.about if profile.about else "-"
    looking_for_text = profile.looking_for if profile.looking_for else "-"

    profile_text += f"""
{mt.PROFILE_ABOUT.format(about_text)}"""
    profile_text += f"""
{mt.PROFILE_LOOKING_FOR.format(looking_for_text)}"""

    return profile_text

def get_gendered_field_value(obj, user_language: str, gender: str) -> str:
    if not obj:
        return ""

    lang = user_language.lower()
    gender = gender.lower()

    field_map = {
        ("uz", "male"): "uz_male",
        ("uz", "female"): "uz_female",
        ("ru", "male"): "ru_male",
        ("ru", "female"): "ru_female",
        ("en", "male"): "en_male",
        ("en", "female"): "en_female",
    }

    field_name = field_map.get((lang, gender))

    return getattr(obj, field_name, "")
